'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import PublicLayout from '@/components/PublicLayout';
import {
  ArrowLeft, CheckCircle, FileText, Shield, Clock,
  Loader2, CreditCard, Users, Phone, Mail, MessageSquare
} from 'lucide-react';

type Language = 'ja' | 'zh-TW' | 'zh-CN' | 'en';

// é¡µé¢ç¿»è¯‘
const pageTranslations = {
  serviceName: { ja: 'åˆæœŸç›¸è«‡ã‚µãƒ¼ãƒ“ã‚¹', 'zh-TW': 'å‰æœŸè«®è©¢æœå‹™', 'zh-CN': 'å‰æœŸå’¨è¯¢æœåŠ¡', en: 'Initial Consultation' } as Record<Language, string>,
  description: { ja: 'è³‡æ–™ç¿»è¨³ãƒ»ç—…é™¢ç›¸è«‡ãƒ»æ²»ç™‚ãƒ—ãƒ©ãƒ³åˆæœŸè©•ä¾¡', 'zh-TW': 'è³‡æ–™ç¿»è­¯ã€é†«é™¢è«®è©¢ã€æ²»ç™‚æ–¹æ¡ˆåˆæ­¥è©•ä¼°', 'zh-CN': 'èµ„æ–™ç¿»è¯‘ã€åŒ»é™¢å’¨è¯¢ã€æ²»ç–—æ–¹æ¡ˆåˆæ­¥è¯„ä¼°', en: 'Document translation, hospital consultation, initial treatment assessment' } as Record<Language, string>,
  longDescription: { ja: 'ãŒã‚“æ‚£è€…æ§˜å°‚ç”¨ã®åˆæœŸç›¸è«‡ã‚µãƒ¼ãƒ“ã‚¹ã€‚è¨ºç™‚æƒ…å ±ã‚’ç¿»è¨³ï¼ˆä¸­â†’æ—¥ï¼‰ã—ã€æ—¥æœ¬ã®ææºç—…é™¢ã¨åˆæœŸç›¸è«‡ã‚’è¡Œã„ã€æ²»ç™‚å¯èƒ½æ€§ã‚’è©•ä¾¡ã—è²»ç”¨æ¦‚ç®—ã‚’ã”æç¤ºã—ã¾ã™ã€‚', 'zh-TW': 'å°ˆç‚ºç™Œç—‡æ‚£è€…æä¾›çš„å‰æœŸè«®è©¢æœå‹™ã€‚æˆ‘å€‘å°‡ç¿»è­¯æ‚¨çš„ç—…æ­·è³‡æ–™ï¼ˆä¸­æ–‡â†’æ—¥æ–‡ï¼‰ï¼Œä¸¦èˆ‡æ—¥æœ¬åˆä½œé†«é™¢é€²è¡Œåˆæ­¥è«®è©¢ï¼Œè©•ä¼°æ²»ç™‚å¯è¡Œæ€§ä¸¦æä¾›è²»ç”¨æ¦‚ç®—ã€‚', 'zh-CN': 'ä¸“ä¸ºç™Œç—‡æ‚£è€…æä¾›çš„å‰æœŸå’¨è¯¢æœåŠ¡ã€‚æˆ‘ä»¬å°†ç¿»è¯‘æ‚¨çš„ç—…å†èµ„æ–™ï¼ˆä¸­æ–‡â†’æ—¥æ–‡ï¼‰ï¼Œå¹¶ä¸æ—¥æœ¬åˆä½œåŒ»é™¢è¿›è¡Œåˆæ­¥å’¨è¯¢ï¼Œè¯„ä¼°æ²»ç–—å¯è¡Œæ€§å¹¶æä¾›è´¹ç”¨æ¦‚ç®—ã€‚', en: 'Consultation service for cancer patients. We translate your medical records (CNâ†’JP), consult with partner hospitals in Japan, assess treatment feasibility and provide cost estimates.' } as Record<Language, string>,
  backToTreatment: { ja: 'æ²»ç™‚ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹', 'zh-TW': 'è¿”å›æ—¥æœ¬ç¶œåˆæ²»ç™‚', 'zh-CN': 'è¿”å›æ—¥æœ¬ç»¼åˆæ²»ç–—', en: 'Back to Cancer Treatment' } as Record<Language, string>,
  features: { ja: ['è¨ºç™‚æƒ…å ±ã®ç¿»è¨³ï¼ˆä¸­â†’æ—¥ï¼‰', 'æ—¥æœ¬ã®ç—…é™¢ã¸ã®åˆæœŸç›¸è«‡', 'æ²»ç™‚å¯èƒ½æ€§è©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆ', 'è²»ç”¨æ¦‚ç®—ã®ã”èª¬æ˜', 'å¾Œç¶šãƒ•ãƒ­ãƒ¼ã®ã”æ¡ˆå†…'], 'zh-TW': ['ç—…æ­·è³‡æ–™ç¿»è­¯ï¼ˆä¸­â†’æ—¥ï¼‰', 'æ—¥æœ¬é†«é™¢åˆæ­¥è«®è©¢', 'æ²»ç™‚å¯è¡Œæ€§è©•ä¼°å ±å‘Š', 'è²»ç”¨æ¦‚ç®—èªªæ˜', 'å¾ŒçºŒæµç¨‹æŒ‡å°'], 'zh-CN': ['ç—…å†èµ„æ–™ç¿»è¯‘ï¼ˆä¸­â†’æ—¥ï¼‰', 'æ—¥æœ¬åŒ»é™¢åˆæ­¥å’¨è¯¢', 'æ²»ç–—å¯è¡Œæ€§è¯„ä¼°æŠ¥å‘Š', 'è´¹ç”¨æ¦‚ç®—è¯´æ˜', 'åç»­æµç¨‹æŒ‡å¯¼'], en: ['Medical record translation (CNâ†’JP)', 'Initial hospital consultation', 'Treatment feasibility report', 'Cost estimation', 'Follow-up process guidance'] } as Record<Language, string[]>,
  requiredDocs: { ja: ['è¡€æ¶²æ¤œæŸ»å ±å‘Šãƒ»ç—…ç†å ±å‘Š', 'CT/MRI/PET ç­‰ã®ç”»åƒæ¤œæŸ»ãƒ‡ãƒ¼ã‚¿', 'æ‰‹è¡“è¨˜éŒ²ï¼ˆã‚ã‚‹å ´åˆï¼‰', 'ç¾åœ¨ã®æŠ•è–¬ãƒªã‚¹ãƒˆ', 'æ—¢å¾€æ­´æ¦‚è¦'], 'zh-TW': ['è¡€æ¶²æª¢æŸ¥å ±å‘Šã€ç—…ç†å ±å‘Š', 'CT/MRI/PET ç­‰å½±åƒæª¢æŸ¥è³‡æ–™', 'æ‰‹è¡“è¨˜éŒ„ï¼ˆå¦‚æœ‰ï¼‰', 'ç›®å‰ç”¨è—¥æ¸…å–®', 'æ—¢å¾€ç—…å²ç°¡è¿°'], 'zh-CN': ['è¡€æ¶²æ£€æŸ¥æŠ¥å‘Šã€ç—…ç†æŠ¥å‘Š', 'CT/MRI/PET ç­‰å½±åƒæ£€æŸ¥èµ„æ–™', 'æ‰‹æœ¯è®°å½•ï¼ˆå¦‚æœ‰ï¼‰', 'ç›®å‰ç”¨è¯æ¸…å•', 'æ—¢å¾€ç—…å²ç®€è¿°'], en: ['Blood test & pathology reports', 'CT/MRI/PET imaging data', 'Surgical records (if any)', 'Current medication list', 'Medical history summary'] } as Record<Language, string[]>,
  price: { ja: 'æ—¥å††ï¼ˆç¨è¾¼ï¼‰', 'zh-TW': 'æ—¥å…ƒï¼ˆå«ç¨…ï¼‰', 'zh-CN': 'æ—¥å…ƒï¼ˆå«ç¨ï¼‰', en: 'JPY (tax incl.)' } as Record<Language, string>,
  serviceDetails: { ja: 'ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°', 'zh-TW': 'æœå‹™è©³æƒ…', 'zh-CN': 'æœåŠ¡è¯¦æƒ…', en: 'Service Details' } as Record<Language, string>,
  serviceFeatures: { ja: 'ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹', 'zh-TW': 'æœå‹™å…§å®¹', 'zh-CN': 'æœåŠ¡å†…å®¹', en: 'Service Features' } as Record<Language, string>,
  docsNeeded: { ja: 'å¿…è¦ãªè³‡æ–™', 'zh-TW': 'æ‰€éœ€è³‡æ–™', 'zh-CN': 'æ‰€éœ€èµ„æ–™', en: 'Required Documents' } as Record<Language, string>,
  bookingForm: { ja: 'äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ', 'zh-TW': 'é ç´„è¡¨å–®', 'zh-CN': 'é¢„çº¦è¡¨å•', en: 'Booking Form' } as Record<Language, string>,
  contactInfo: { ja: 'ãŠå®¢æ§˜æƒ…å ±', 'zh-TW': 'è¯ç¹«è³‡è¨Š', 'zh-CN': 'è”ç³»ä¿¡æ¯', en: 'Contact Information' } as Record<Language, string>,
  name: { ja: 'ãŠåå‰', 'zh-TW': 'å§“å', 'zh-CN': 'å§“å', en: 'Full Name' } as Record<Language, string>,
  email: { ja: 'ãƒ¡ãƒ¼ãƒ«', 'zh-TW': 'é›»å­éƒµä»¶', 'zh-CN': 'ç”µå­é‚®ä»¶', en: 'Email' } as Record<Language, string>,
  phone: { ja: 'é›»è©±', 'zh-TW': 'é›»è©±', 'zh-CN': 'ç”µè¯', en: 'Phone' } as Record<Language, string>,
  lineId: { ja: 'LINE ID', 'zh-TW': 'LINE ID', 'zh-CN': 'LINE ID', en: 'LINE ID' } as Record<Language, string>,
  wechatId: { ja: 'WeChat ID', 'zh-TW': 'å¾®ä¿¡ ID', 'zh-CN': 'å¾®ä¿¡ ID', en: 'WeChat ID' } as Record<Language, string>,
  country: { ja: 'å›½ãƒ»åœ°åŸŸ', 'zh-TW': 'åœ‹å®¶/åœ°å€', 'zh-CN': 'å›½å®¶/åœ°åŒº', en: 'Country/Region' } as Record<Language, string>,
  patientInfo: { ja: 'æ‚£è€…æƒ…å ±', 'zh-TW': 'æ‚£è€…è³‡è¨Š', 'zh-CN': 'æ‚£è€…ä¿¡æ¯', en: 'Patient Information' } as Record<Language, string>,
  patientName: { ja: 'æ‚£è€…æ°å', 'zh-TW': 'æ‚£è€…å§“å', 'zh-CN': 'æ‚£è€…å§“å', en: 'Patient Name' } as Record<Language, string>,
  age: { ja: 'å¹´é½¢', 'zh-TW': 'å¹´é½¡', 'zh-CN': 'å¹´é¾„', en: 'Age' } as Record<Language, string>,
  gender: { ja: 'æ€§åˆ¥', 'zh-TW': 'æ€§åˆ¥', 'zh-CN': 'æ€§åˆ«', en: 'Gender' } as Record<Language, string>,
  male: { ja: 'ç”·æ€§', 'zh-TW': 'ç”·', 'zh-CN': 'ç”·', en: 'Male' } as Record<Language, string>,
  female: { ja: 'å¥³æ€§', 'zh-TW': 'å¥³', 'zh-CN': 'å¥³', en: 'Female' } as Record<Language, string>,
  diagnosis: { ja: 'è¨ºæ–­', 'zh-TW': 'è¨ºæ–·ç—…å', 'zh-CN': 'è¯Šæ–­ç—…å', en: 'Diagnosis' } as Record<Language, string>,
  currentStatus: { ja: 'ç¾åœ¨ã®çŠ¶æ…‹', 'zh-TW': 'ç›®å‰ç‹€æ³', 'zh-CN': 'ç›®å‰çŠ¶å†µ', en: 'Current Status' } as Record<Language, string>,
  additionalNotes: { ja: 'è£œè¶³èª¬æ˜', 'zh-TW': 'è£œå……èªªæ˜', 'zh-CN': 'è¡¥å……è¯´æ˜', en: 'Additional Notes' } as Record<Language, string>,
  optional: { ja: 'ä»»æ„', 'zh-TW': 'é¸å¡«', 'zh-CN': 'é€‰å¡«', en: 'Optional' } as Record<Language, string>,
  proceedToPayment: { ja: 'ãŠæ”¯æ‰•ã„ã¸é€²ã‚€', 'zh-TW': 'å‰å¾€æ”¯ä»˜', 'zh-CN': 'å‰å¾€æ”¯ä»˜', en: 'Proceed to Payment' } as Record<Language, string>,
  processing: { ja: 'å‡¦ç†ä¸­...', 'zh-TW': 'è™•ç†ä¸­...', 'zh-CN': 'å¤„ç†ä¸­...', en: 'Processing...' } as Record<Language, string>,
  contactMethodRequired: { ja: 'â€» é›»è©±ã€ãƒ¡ãƒ¼ãƒ«ã€LINEã€WeChatã®ã„ãšã‚Œã‹1ã¤ä»¥ä¸Šã‚’ã”å…¥åŠ›ãã ã•ã„', 'zh-TW': 'â€» è«‹è‡³å°‘å¡«å¯«ä¸€ç¨®è¯ç¹«æ–¹å¼ï¼ˆé›»è©±ã€éƒµç®±ã€LINE æˆ–å¾®ä¿¡ï¼‰', 'zh-CN': 'â€» è¯·è‡³å°‘å¡«å†™ä¸€ç§è”ç³»æ–¹å¼ï¼ˆç”µè¯ã€é‚®ç®±ã€LINE æˆ–å¾®ä¿¡ï¼‰', en: 'â€» Please provide at least one contact method (Phone, Email, LINE, or WeChat)' } as Record<Language, string>,
};

const SERVICE_INFO = {
  id: 'cancer-initial-consultation',
  slug: 'cancer-initial-consultation',
  nameEn: 'Initial Consultation',
  price: 221000,
};

export default function InitialConsultationPage() {
  const [currentLang, setCurrentLang] = useState<Language>('zh-TW');

  // è¯­è¨€æ£€æµ‹
  useEffect(() => {
    const getCookie = (name: string): string | null => {
      if (typeof document === 'undefined') return null;
      const cookies = document.cookie.split(';');
      for (const cookie of cookies) {
        const trimmed = cookie.trim();
        const equalsIndex = trimmed.indexOf('=');
        if (equalsIndex === -1) continue;
        const cookieName = trimmed.substring(0, equalsIndex);
        const cookieValue = trimmed.substring(equalsIndex + 1);
        if (cookieName === name) {
          try {
            return decodeURIComponent(cookieValue);
          } catch {
            return cookieValue;
          }
        }
      }
      return null;
    };

    const localeCookie = getCookie('NEXT_LOCALE');
    const validLocales: Language[] = ['ja', 'zh-TW', 'zh-CN', 'en'];
    if (localeCookie && validLocales.includes(localeCookie as Language)) {
      setCurrentLang(localeCookie as Language);
      return;
    }

    const browserLang = navigator.language;
    if (browserLang.startsWith('ja')) setCurrentLang('ja');
    else if (browserLang === 'zh-TW' || browserLang === 'zh-Hant') setCurrentLang('zh-TW');
    else if (browserLang === 'zh-CN' || browserLang === 'zh-Hans' || browserLang.startsWith('zh')) setCurrentLang('zh-CN');
    else if (browserLang.startsWith('en')) setCurrentLang('en');
  }, []);

  const t = (key: keyof typeof pageTranslations) => pageTranslations[key][currentLang];
  const [processing, setProcessing] = useState(false);
  const [customerInfo, setCustomerInfo] = useState({
    name: '',
    email: '',
    phone: '',
    line: '',
    wechat: '',
    country: 'TW',
  });
  const [patientInfo, setPatientInfo] = useState({
    patientName: '',
    age: '',
    gender: '',
    diagnosis: '',
    currentStatus: '',
  });
  const [notes, setNotes] = useState('');
  const [contactError, setContactError] = useState('');

  const hasValidContact = () => {
    return customerInfo.phone.trim() !== '' ||
           customerInfo.email.trim() !== '' ||
           customerInfo.line.trim() !== '' ||
           customerInfo.wechat.trim() !== '';
  };

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setContactError('');
    setProcessing(true);

    try {
      if (!customerInfo.name) {
        alert('è«‹å¡«å¯«è¯ç¹«äººå§“å');
        setProcessing(false);
        return;
      }
      if (!patientInfo.patientName) {
        alert('è«‹å¡«å¯«æ‚£è€…å§“å');
        setProcessing(false);
        return;
      }
      if (!hasValidContact()) {
        setContactError('è«‹è‡³å°‘å¡«å¯«ä¸€ç¨®è¯ç¹«æ–¹å¼ï¼ˆæ‰‹æ©Ÿã€éƒµç®±ã€LINE æˆ–å¾®ä¿¡ï¼‰');
        setProcessing(false);
        return;
      }

      // æ„å»ºè”ç³»æ–¹å¼ä¿¡æ¯
      const contactMethods: string[] = [];
      if (customerInfo.phone) contactMethods.push(`é›»è©±: ${customerInfo.phone}`);
      if (customerInfo.email) contactMethods.push(`éƒµç®±: ${customerInfo.email}`);
      if (customerInfo.line) contactMethods.push(`LINE: ${customerInfo.line}`);
      if (customerInfo.wechat) contactMethods.push(`å¾®ä¿¡: ${customerInfo.wechat}`);

      let fullNotes = `ã€ç™Œç—‡æ²»ç™‚ - å‰æœŸè«®è©¢æœå‹™ã€‘\n\n`;
      fullNotes += `ã€æ‚£è€…ä¿¡æ¯ã€‘\n`;
      fullNotes += `å§“å: ${patientInfo.patientName}\n`;
      fullNotes += `å¹´é½¡: ${patientInfo.age || 'æœªæä¾›'}\n`;
      fullNotes += `æ€§åˆ¥: ${patientInfo.gender || 'æœªæä¾›'}\n`;
      fullNotes += `è¨ºæ–·: ${patientInfo.diagnosis || 'æœªæä¾›'}\n`;
      fullNotes += `ç›®å‰ç‹€æ³: ${patientInfo.currentStatus || 'æœªæä¾›'}\n\n`;
      fullNotes += `ã€è¯ç¹«æ–¹å¼ã€‘\n${contactMethods.join('\n')}\n\n`;
      if (notes) {
        fullNotes += `ã€è£œå……èªªæ˜ã€‘\n${notes}`;
      }

      // ğŸ”’ å®‰å…¨å¤„ç†é‚®ç®±ï¼šä½¿ç”¨ UUID ç”Ÿæˆå ä½ç¬¦é‚®ç®±ï¼Œé¿å… XSS é£é™©
      const safeEmail = customerInfo.email || `customer-${crypto.randomUUID()}@placeholder.niijima.jp`;

      const response = await fetch('/api/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          packageSlug: SERVICE_INFO.slug,
          customerInfo: {
            name: customerInfo.name,
            email: safeEmail,
            phone: customerInfo.phone,
            line: customerInfo.line,
            wechat: customerInfo.wechat,
            country: customerInfo.country,
          },
          preferredDate: null,
          preferredTime: null,
          notes: fullNotes,
        }),
      });

      const data = await response.json();
      if (!response.ok) throw new Error(data.error || 'å‰µå»ºæ”¯ä»˜æœƒè©±å¤±æ•—');
      if (data.checkoutUrl) window.location.href = data.checkoutUrl;
      else throw new Error('æœªç²å–åˆ°æ”¯ä»˜éˆæ¥');
    } catch (error: any) {
      alert(error.message || 'æ”¯ä»˜æµç¨‹å‡ºç¾éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦');
    } finally {
      setProcessing(false);
    }
  }

  return (
    <PublicLayout showFooter={true} transparentNav={false}>
      {/* Header */}
      <div className="pt-20 bg-white border-b border-gray-100">
        <div className="max-w-4xl mx-auto px-4 py-4">
          <Link
            href="/cancer-treatment"
            className="inline-flex items-center gap-2 text-gray-500 hover:text-blue-600 transition"
          >
            <ArrowLeft size={16} />
            è¿”å›æ—¥æœ¬ç¶œåˆæ²»ç™‚
          </Link>
        </div>
      </div>

      {/* Hero */}
      <div className="bg-gradient-to-r from-blue-600 to-indigo-700 py-12">
        <div className="max-w-4xl mx-auto px-4">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
            <div>
              <h1 className="text-3xl font-serif font-bold text-white">{SERVICE_INFO.name}</h1>
              <p className="text-blue-200 text-sm mt-1">{SERVICE_INFO.nameEn}</p>
            </div>
            <div className="text-right">
              <p className="text-4xl font-bold text-white">Â¥{SERVICE_INFO.price.toLocaleString()}</p>
              <p className="text-xs text-blue-200 mt-1">æ—¥å††ï¼ˆç¨è¾¼ï¼‰</p>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-4xl mx-auto px-4 py-12">
        <div className="grid lg:grid-cols-3 gap-8">
          {/* Left: Service Info */}
          <div className="lg:col-span-1">
            <div className="bg-blue-50 rounded-2xl p-6 border border-blue-100 sticky top-8">
              <h3 className="text-lg font-bold text-blue-900 mb-3">æœå‹™åŒ…å«</h3>
              <p className="text-sm text-gray-600 mb-6 leading-relaxed">{SERVICE_INFO.longDescription}</p>
              <div className="space-y-2.5 text-sm text-gray-700">
                {SERVICE_INFO.features.map((feature, idx) => (
                  <div key={idx} className="flex gap-2">
                    <CheckCircle size={16} className="shrink-0 mt-0.5 text-blue-500" />
                    <span>{feature}</span>
                  </div>
                ))}
              </div>
              <div className="mt-6 pt-6 border-t border-blue-200">
                <h4 className="font-bold text-gray-900 mb-3 flex items-center gap-2">
                  <FileText size={16} className="text-blue-600" />
                  è«‹æº–å‚™ä»¥ä¸‹è³‡æ–™
                </h4>
                <ul className="space-y-2 text-sm text-gray-600">
                  {SERVICE_INFO.requiredDocs.map((doc, idx) => (
                    <li key={idx} className="flex gap-2">
                      <span className="text-gray-400">â€¢</span>
                      <span>{doc}</span>
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          </div>

          {/* Right: Booking Form */}
          <div className="lg:col-span-2">
            <div className="bg-white rounded-2xl border border-gray-200 p-8">
              <h2 className="text-2xl font-serif font-bold text-gray-900 mb-6">é ç´„ä¿¡æ¯</h2>

              {/* åˆåŒä¸»ä½“å£°æ˜ */}
              <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                <p className="text-sm text-blue-800">
                  <strong>ã”å¥‘ç´„ã«ã¤ã„ã¦ï¼š</strong>æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®ã”å¥‘ç´„ã¯ã€æ–°å³¶äº¤é€šæ ªå¼ä¼šç¤¾ï¼ˆå¤§é˜ªåºœçŸ¥äº‹ç™»éŒ²æ—…è¡Œæ¥­ ç¬¬2-3115å·ï¼‰ã¨ã®é–“ã§ç· çµã•ã‚Œã¾ã™ã€‚
                </p>
              </div>

              <form onSubmit={handleSubmit} className="space-y-8">
                {/* Patient Info */}
                <div>
                  <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <Users size={18} className="text-blue-600" />
                    æ‚£è€…ä¿¡æ¯
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">æ‚£è€…å§“å *</label>
                      <input
                        type="text"
                        required
                        value={patientInfo.patientName}
                        onChange={(e) => setPatientInfo({ ...patientInfo, patientName: e.target.value })}
                        className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="è«‹è¼¸å…¥æ‚£è€…å§“å"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">å¹´é½¡</label>
                      <input
                        type="text"
                        value={patientInfo.age}
                        onChange={(e) => setPatientInfo({ ...patientInfo, age: e.target.value })}
                        className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ä¾‹å¦‚ï¼š65æ­²"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ¥</label>
                      <select
                        value={patientInfo.gender}
                        onChange={(e) => setPatientInfo({ ...patientInfo, gender: e.target.value })}
                        className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      >
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">è¨ºæ–·</label>
                      <input
                        type="text"
                        value={patientInfo.diagnosis}
                        onChange={(e) => setPatientInfo({ ...patientInfo, diagnosis: e.target.value })}
                        className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ä¾‹å¦‚ï¼šè‚ºç™ŒIIIæœŸ"
                      />
                    </div>
                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-gray-700 mb-1">ç›®å‰æ²»ç™‚ç‹€æ³</label>
                      <textarea
                        value={patientInfo.currentStatus}
                        onChange={(e) => setPatientInfo({ ...patientInfo, currentStatus: e.target.value })}
                        className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        rows={3}
                        placeholder="è«‹ç°¡è¿°ç›®å‰çš„æ²»ç™‚é€²åº¦ã€ç”¨è—¥æƒ…æ³ç­‰"
                      />
                    </div>
                  </div>
                </div>

                {/* Contact Info */}
                <div>
                  <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <Phone size={18} className="text-blue-600" />
                    è¯ç¹«äººä¿¡æ¯
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">è¯ç¹«äººå§“å *</label>
                      <input
                        type="text"
                        required
                        value={customerInfo.name}
                        onChange={(e) => setCustomerInfo({ ...customerInfo, name: e.target.value })}
                        className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="è«‹è¼¸å…¥è¯ç¹«äººå§“å"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">æ‰€åœ¨åœ°å€</label>
                      <select
                        value={customerInfo.country}
                        onChange={(e) => setCustomerInfo({ ...customerInfo, country: e.target.value })}
                        className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      >
                        <option value="TW">å°ç£</option>
                        <option value="CN">ä¸­åœ‹å¤§é™¸</option>
                        <option value="HK">é¦™æ¸¯</option>
                        <option value="SG">æ–°åŠ å¡</option>
                        <option value="MY">é¦¬ä¾†è¥¿äº</option>
                        <option value="OTHER">å…¶ä»–</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                      <input
                        type="tel"
                        value={customerInfo.phone}
                        onChange={(e) => setCustomerInfo({ ...customerInfo, phone: e.target.value })}
                        className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="+886 912345678"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">é›»å­éƒµç®±</label>
                      <input
                        type="email"
                        value={customerInfo.email}
                        onChange={(e) => setCustomerInfo({ ...customerInfo, email: e.target.value })}
                        className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="example@email.com"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">LINE ID</label>
                      <input
                        type="text"
                        value={customerInfo.line}
                        onChange={(e) => setCustomerInfo({ ...customerInfo, line: e.target.value })}
                        className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="æ‚¨çš„ LINE ID"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">å¾®ä¿¡ WeChat</label>
                      <input
                        type="text"
                        value={customerInfo.wechat}
                        onChange={(e) => setCustomerInfo({ ...customerInfo, wechat: e.target.value })}
                        className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="æ‚¨çš„å¾®ä¿¡è™Ÿ"
                      />
                    </div>
                  </div>
                  {contactError && (
                    <p className="mt-2 text-sm text-red-500">{contactError}</p>
                  )}
                  <p className="mt-2 text-xs text-gray-400">* è‡³å°‘å¡«å¯«ä¸€ç¨®è¯ç¹«æ–¹å¼</p>
                </div>

                {/* Notes */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">è£œå……èªªæ˜</label>
                  <textarea
                    value={notes}
                    onChange={(e) => setNotes(e.target.value)}
                    className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    rows={4}
                    placeholder="å¦‚æœ‰å…¶ä»–éœ€è¦èªªæ˜çš„æƒ…æ³ï¼Œè«‹åœ¨æ­¤å¡«å¯«"
                  />
                </div>

                {/* Summary */}
                <div className="bg-gray-50 rounded-xl p-6 border border-gray-200">
                  <div className="flex justify-between items-center mb-4">
                    <span className="text-gray-600">æœå‹™è²»ç”¨</span>
                    <div className="text-right">
                      <span className="text-2xl font-bold text-gray-900">Â¥{SERVICE_INFO.price.toLocaleString()}</span>
                      <span className="text-xs text-gray-500 ml-1">æ—¥å††</span>
                    </div>
                  </div>
                  <p className="text-xs text-gray-500 mb-4">
                    æ”¯ä»˜å®Œæˆå¾Œï¼Œæˆ‘å€‘å°‡åœ¨ 24 å°æ™‚å…§èˆ‡æ‚¨è¯ç¹«ï¼Œç¢ºèªè³‡æ–™æäº¤æ–¹å¼
                  </p>
                  <button
                    type="submit"
                    disabled={processing}
                    className="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-bold rounded-xl hover:from-blue-700 hover:to-indigo-800 transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    {processing ? (
                      <>
                        <Loader2 className="animate-spin" size={20} />
                        è™•ç†ä¸­...
                      </>
                    ) : (
                      <>
                        <CreditCard size={20} />
                        ç¢ºèªä¸¦æ”¯ä»˜
                      </>
                    )}
                  </button>
                </div>

                {/* Trust Indicators */}
                <div className="flex flex-wrap justify-center gap-6 text-xs text-gray-500">
                  <div className="flex items-center gap-1">
                    <Shield size={14} className="text-green-500" />
                    <span>å®‰å…¨æ”¯ä»˜</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <Clock size={14} className="text-blue-500" />
                    <span>24å°æ™‚å…§è¯ç¹«</span>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </PublicLayout>
  );
}
